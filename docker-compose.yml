services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: imaging360-postgres
    environment:
      POSTGRES_USER: imaging360
      POSTGRES_PASSWORD: imaging360_dev
      POSTGRES_DB: imaging360
    ports:
      - "5433:5432"  # Use 5433 to avoid conflict with host PostgreSQL
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imaging360"]
      interval: 5s
      timeout: 5s
      retries: 5

  # LocalStack for S3 and SQS
  localstack:
    image: localstack/localstack:3.0
    container_name: imaging360-localstack
    ports:
      - "4566:4566"
    environment:
      SERVICES: s3,sqs
      DEBUG: 0
      PERSISTENCE: 1
    volumes:
      - localstack_data:/var/lib/localstack
      - ./infra/localstack/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  # API Service
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: imaging360-api
    ports:
      - "3001:3000"  # Use 3001 to avoid conflict with host apps
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://imaging360:imaging360_dev@postgres:5432/imaging360
      JWT_SECRET: dev-jwt-secret-change-in-production
      AWS_ENDPOINT: http://localstack:4566
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_BUCKET: imaging360-dev
      SQS_QUEUE_URL: http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/imaging360-uploads
      CORS_ORIGIN: http://localhost:5173
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Worker Service
  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    container_name: imaging360-worker
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://imaging360:imaging360_dev@postgres:5432/imaging360
      AWS_ENDPOINT: http://localstack:4566
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_BUCKET: imaging360-dev
      SQS_QUEUE_URL: http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/imaging360-uploads
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy

  # Portal (React frontend)
  portal:
    build:
      context: .
      dockerfile: apps/portal/Dockerfile
    container_name: imaging360-portal
    ports:
      - "5173:80"
    depends_on:
      - api

volumes:
  postgres_data:
  localstack_data:
